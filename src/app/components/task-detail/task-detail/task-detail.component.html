<!-- Modal overlay only when opened in named outlet -->
<div *ngIf="isModal; else fullPage" class="fixed inset-0 z-50">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/40" (click)="close()"></div>

  <!-- Centered container -->
  <div class="relative z-10 h-full flex items-center justify-center p-4 md:p-6">
    <!-- Sheet wrapper: width + max height + internal scroll -->
    <div class="w-full max-w-5xl max-h-[90vh] overflow-y-auto">
      <form [formGroup]="form" class="bg-white border border-slate-200 rounded-2xl shadow-2xl overflow-hidden">

        <!-- Top accent gradient -->
        <div class="h-1 w-full bg-gradient-to-r from-sky-400 via-violet-500 to-emerald-500"></div>

        <!-- Top toolbar (breadcrumb + actions) -->
        <div class="px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-white to-slate-50/60">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 text-slate-600">
              <button type="button" class="px-2 py-1 text-sm rounded border border-slate-200 bg-white hover:bg-slate-50">
                Add epic
              </button>
              <span class="text-slate-300">/</span>
              <span class="text-xs md:text-sm px-2 py-0.5 rounded-full bg-slate-100 border border-slate-200 text-slate-700">
                {{ issueKey }}
              </span>
            </div>
            <div class="flex items-center gap-2 text-slate-500">
              <!-- Edit toggle button -->
              <button
                type="button"
                class="p-2 rounded hover:bg-slate-100"
                [title]="isEditing ? 'Cancel editing' : 'Edit'"
                (click)="toggleEdit()"
              >
                <!-- Pencil icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M16.862 3.487a2.25 2.25 0 013.182 3.182l-9.193 9.193-3.49.308.308-3.49 9.193-9.193z" />
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M19.5 10.5L13.5 4.5" />
                </svg>
              </button>

              <button type="button" class="p-2 rounded hover:bg-slate-100" title="Close" (click)="close()">✕</button>
            </div>
          </div>
        </div>

        <!-- Header: Title + Status chip -->
        <div class="px-6 py-5 border-b border-slate-100 bg-white">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <input
                formControlName="title"
                [readonly]="!isEditing"
                class="w-full text-3xl font-semibold leading-tight bg-slate-50 rounded-xl px-3 py-2 border border-transparent
                       focus:outline-none focus:bg-white focus:border-slate-300 placeholder:text-slate-400"
                placeholder="Issue title"
              />
            </div>
            <div class="flex items-center gap-2">
              <div class="relative">
                <select
                  formControlName="status"
                  class="appearance-none pr-8 pl-3 py-2 rounded-lg text-sm font-medium border shadow-sm bg-white
                         focus:outline-none focus:ring-2 focus:ring-sky-300"
                  [ngClass]="statusChipClass(form.value.status)"
                  [style.pointer-events]="!isEditing ? 'none' : 'auto'"
                  [class.opacity-60]="!isEditing"
                >
                  <option value="OPEN">To Do</option>
                  <option value="IN_PROGRESS">In Progress</option>
                  <option value="DONE">Done</option>
                </select>
                <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-slate-500">▾</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Body -->
        <div class="grid md:grid-cols-3 gap-6 px-6 py-6 bg-white">
          <!-- LEFT -->
          <div class="md:col-span-2 space-y-6">
            <!-- Description card -->
            <div class="rounded-xl border border-slate-200 bg-white">
              <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
                <div class="text-sm font-semibold text-slate-700">Description</div>
                <button type="button" class="p-1.5 rounded hover:bg-slate-100 text-slate-500">⋯</button>
              </div>
              <div class="p-4">
                <textarea
                  formControlName="description"
                  rows="6"
                  [readonly]="!isEditing"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2
                         focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="Add a description..."
                ></textarea>
                <div class="mt-2 text-xs text-slate-400">Markdown supported</div>
              </div>
            </div>
          </div>

          <!-- RIGHT: Details -->
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Details</div>
              <button type="button" class="p-1.5 rounded hover:bg-slate-100 text-slate-500">⚙️</button>
            </div>

            <!-- Assignee card -->
            <div class="rounded-xl border border-slate-200 bg-white p-4 space-y-3">
              <div class="text-xs font-medium text-slate-500">Assignee</div>

              <!-- Admin view: dropdown + assign to me -->
              <div *ngIf="isAdmin; else readonlyAssignee" class="flex items-center gap-2">
                <select
                  class="border rounded-lg px-2 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-sky-300"
                  [ngModel]="selectedAssigneeId"
                  (ngModelChange)="assignTo($event)"
                  [style.pointer-events]="!isEditing ? 'none' : 'auto'"
                  [class.opacity-60]="!isEditing"
                >
                  <option [ngValue]="undefined">Unassigned</option>
                  <option *ngFor="let m of members" [ngValue]="m.id">{{ m.name || m.email }}</option>
                </select>
                <button
                  type="button"
                  class="text-sky-600 hover:underline"
                  (click)="assignToMe()"
                  [disabled]="!meUserId || !isEditing"
                >
                  Assign to me
                </button>
              </div>

              <!-- Non-admin view: read-only -->
              <ng-template #readonlyAssignee>
                <div class="inline-flex items-center gap-2">
                  <span class="inline-flex items-center justify-center w-7 h-7 rounded-full border border-slate-200 bg-slate-50 text-xs font-medium">
                    {{ (assigneeName || 'U') | slice:0:1 }}
                  </span>
                  <span class="text-sm">{{ assigneeName || 'Unassigned' }}</span>
                </div>
              </ng-template>
            </div>

            <!-- Due date card -->
            <div class="rounded-xl border border-slate-200 bg-white p-4 space-y-2">
              <div class="text-xs font-medium text-slate-500">Due date</div>
              <input
                type="datetime-local"
                formControlName="dueDate"
                class="w-full border rounded-lg px-2 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-sky-300"
                [style.pointer-events]="!isEditing ? 'none' : 'auto'"
                [class.opacity-60]="!isEditing"
              />
            </div>

            <!-- Meta row -->
            <div class="rounded-xl border border-slate-200 bg-white px-4 py-3 text-xs text-slate-500 flex items-center justify-between">
              <span>Created • Updated</span>
              <button type="button" class="text-slate-500 hover:underline">Configure</button>
            </div>
          </div>
        </div>

        <!-- Sticky footer actions -->
        <div class="sticky bottom-0 bg-white/95 backdrop-blur border-t border-slate-200 px-6 py-3 flex gap-2">
          <ng-container *ngIf="isEditing; else viewFooterModal">
            <button
              (click)="save()"
              [disabled]="loading"
              class="px-4 py-2 rounded-lg text-white bg-gradient-to-r from-slate-900 to-slate-700 hover:from-slate-800 hover:to-slate-700 disabled:opacity-50 inline-flex items-center gap-2"
            >
              <!-- Check icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                   viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-7.364 7.364a1 1 0 01-1.414 0L3.293 9.435a1 1 0 011.414-1.414l3.222 3.222 6.657-6.657a1 1 0 011.414 0z"
                      clip-rule="evenodd" />
              </svg>
              {{ loading ? 'Saving…' : 'Save' }}
            </button>
            <button
              type="button"
              (click)="cancelEdit()"
              class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50"
            >
              Cancel
            </button>
          </ng-container>

          <ng-template #viewFooterModal>
            <button
              type="button"
              class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 inline-flex items-center gap-2"
              (click)="toggleEdit()"
              title="Edit"
            >
              <!-- Pencil icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                   fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M16.862 3.487a2.25 2.25 0 013.182 3.182l-9.193 9.193-3.49.308.308-3.49 9.193-9.193z" />
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M19.5 10.5L13.5 4.5" />
              </svg>
              Edit
            </button>
          </ng-template>

          <button
            (click)="delete()"
            class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 ml-auto"
          >
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Full page fallback stays same (with edit/read-only + due date) -->
<ng-template #fullPage>
  <div class="max-w-5xl mx-auto p-6">
    <form [formGroup]="form" class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
      <div class="h-1 w-full bg-gradient-to-r from-sky-400 via-violet-500 to-emerald-500"></div>

      <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
        <div class="text-lg font-semibold">Task</div>

        <div class="flex items-center gap-2">
          <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 border border-slate-200">{{ issueKey }}</span>

          <!-- Edit toggle in full page too -->
          <button
            type="button"
            class="p-2 rounded hover:bg-slate-100 text-slate-600"
            [title]="isEditing ? 'Cancel editing' : 'Edit'"
            (click)="toggleEdit()"
          >
            <!-- Pencil icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.862 3.487a2.25 2.25 0 013.182 3.182l-9.193 9.193-3.49.308.308-3.49 9.193-9.193z" />
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M19.5 10.5L13.5 4.5" />
            </svg>
          </button>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6 p-6">
        <div class="md:col-span-2 space-y-4">
          <input
            formControlName="title"
            [readonly]="!isEditing"
            class="w-full text-2xl font-semibold bg-slate-50 rounded-lg px-3 py-2 border border-transparent
                   focus:outline-none focus:bg-white focus:border-slate-300"
            placeholder="Issue title"
          />
          <textarea
            formControlName="description"
            rows="6"
            [readonly]="!isEditing"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500"
            placeholder="Add a description..."
          ></textarea>
        </div>

        <div class="space-y-4">
          <div class="text-sm font-semibold">Details</div>
          <div class="rounded-xl border border-slate-200 p-4 space-y-3">
            <div class="text-xs text-slate-500">Status</div>
            <select
              formControlName="status"
              class="w-full border rounded-lg px-2 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-sky-300"
              [ngClass]="statusChipClass(form.value.status)"
              [style.pointer-events]="!isEditing ? 'none' : 'auto'"
              [class.opacity-60]="!isEditing"
            >
              <option value="OPEN">To Do</option>
              <option value="IN_PROGRESS">In Progress</option>
              <option value="DONE">Done</option>
            </select>
          </div>

          <!-- Assignee (same as modal right card) -->
          <div class="rounded-xl border border-slate-200 p-4 space-y-3 bg-white">
            <div class="text-xs font-medium text-slate-500">Assignee</div>

            <div *ngIf="isAdmin; else readonlyAssigneeFull" class="flex items-center gap-2">
              <select
                class="border rounded-lg px-2 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-sky-300"
                [ngModel]="selectedAssigneeId"
                (ngModelChange)="assignTo($event)"
                [style.pointer-events]="!isEditing ? 'none' : 'auto'"
                [class.opacity-60]="!isEditing"
              >
                <option [ngValue]="undefined">Unassigned</option>
                <option *ngFor="let m of members" [ngValue]="m.id">{{ m.name || m.email }}</option>
              </select>
              <button
                type="button"
                class="text-sky-600 hover:underline"
                (click)="assignToMe()"
                [disabled]="!meUserId || !isEditing"
              >
                Assign to me
              </button>
            </div>

            <ng-template #readonlyAssigneeFull>
              <div class="inline-flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-7 h-7 rounded-full border border-slate-200 bg-slate-50 text-xs font-medium">
                  {{ (assigneeName || 'U') | slice:0:1 }}
                </span>
                <span class="text-sm">{{ assigneeName || 'Unassigned' }}</span>
              </div>
            </ng-template>
          </div>

          <!-- Due date -->
          <div class="rounded-xl border border-slate-200 p-4 space-y-2 bg-white">
            <div class="text-xs font-medium text-slate-500">Due date</div>
            <input
              type="datetime-local"
              formControlName="dueDate"
              class="w-full border rounded-lg px-2 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-sky-300"
              [style.pointer-events]="!isEditing ? 'none' : 'auto'"
              [class.opacity-60]="!isEditing"
            />
          </div>
        </div>
      </div>

      <div class="px-6 py-3 border-t flex gap-2">
        <ng-container *ngIf="isEditing; else viewFooterFull">
          <button
            (click)="save()"
            [disabled]="loading"
            class="px-4 py-2 rounded-lg text-white bg-gradient-to-r from-slate-900 to-slate-700 hover:from-slate-800 hover:to-slate-700 disabled:opacity-50 inline-flex items-center gap-2"
          >
            <!-- Check icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                 viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-7.364 7.364a1 1 0 01-1.414 0L3.293 9.435a1 1 0 011.414-1.414l3.222 3.222 6.657-6.657a1 1 0 011.414 0z"
                    clip-rule="evenodd" />
            </svg>
            {{ loading ? 'Saving…' : 'Save' }}
          </button>
          <button
            type="button"
            (click)="cancelEdit()"
            class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50"
          >
            Cancel
          </button>
        </ng-container>

        <ng-template #viewFooterFull>
          <button
            type="button"
            class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 inline-flex items-center gap-2"
            (click)="toggleEdit()"
            title="Edit"
          >
            <!-- Pencil icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.862 3.487a2.25 2.25 0 013.182 3.182l-9.193 9.193-3.49.308.308-3.49 9.193-9.193z" />
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M19.5 10.5L13.5 4.5" />
            </svg>
            Edit
          </button>
        </ng-template>

        <button (click)="delete()" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-500 ml-auto">
          Delete
        </button>
      </div>
    </form>
  </div>
</ng-template>